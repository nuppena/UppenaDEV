sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/m/MessageBox","pcf/com/acc/packaging/service/odataHelper"],(e,t,a,i)=>{"use strict";return e.extend("pcf.com.acc.packaging.controller.Packaging",{onInit(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"excelData");this.PackagingState=this.getOwnerComponent().getState("Packaging");this.PackagingService=this.getOwnerComponent().getService("Packaging");this.getView().getModel("excelData").setProperty("/btEditEnabled","InActive");this.oGlobalBusyDialog=new sap.m.BusyDialog;this.getUserInfo()},onSaveChanges:function(){const e=this;const t=this.getView().getModel("excelData");if(!t||!t.getData().results||t.getData().results.length===0){a.warning("No data available to save.");return}const o=t.getData().results;const n=[];var r;var s;for(let e=0;e<o.length;e++){if(o[e]["Weight"].length==0){r=null}else{r=o[e]["Weight"]}if(o[e]["Spend (in Millions)"].toString().length==0){s=null}else{s=o[e]["Spend (in Millions)"]}n.push({Site_ID:o[e]["Site ID"],Country_Name:o[e]["Country Name"],Material_ID:String(o[e]["Material ID"]),Material_Name:o[e]["Material Name"],Short_Description:o[e]["Short Description"],Weight:r,Weight_Unit:o[e]["Weight Unit"],Spend:s,Spend_Currency_Unit:o[e]["Spend Currency Unit"]})}const l={uName:"u1234",Industry:"Dairy",material:n};this.oGlobalBusyDialog.open();var c=this.getOwnerComponent().getModel();i.postData(c,"/saveData",l).then(t=>{if(t.saveData.result=="Material details stored successfully."){e.onRunExecute()}if(t.saveData.statusCode==502){let e=t.saveData.reason.response.body.error;a.error(e.split(":")[1]+":"+e.split(":")[2]);this.oGlobalBusyDialog.close()}}).catch(e=>{console.error("Error reading data:",e);this.oGlobalBusyDialog.close()})},onEditChanges:function(){var e=this;const t=[];const a=this.getView().getModel("excelData");const o=a.getData().results;for(let e=0;e<o.length;e++){t.push({row_id:o[e].row_id,active_result_id:o[e].active_result_id,Total_Emission:o[e]["Total Emission"]})}const n={editPayload:t};this.oGlobalBusyDialog.open();var r=this.getOwnerComponent().getModel();i.postData(r,"/editData",n).then(t=>{e.onRunExecute()}).catch(e=>{console.error("Error reading data:",e);this.oGlobalBusyDialog.close()})},getUserInfo:function(){$.ajax({method:"GET",url:"/user-api/currentUser",async:true,success:function(e){console.log(JSON.stringify(e))},error:function(e){console.log(e)}})},onRunExecute:function(){const e=this;var t=this.getOwnerComponent().getModel();i.readData(t,"/runAPI").then(t=>{if(t.runAPI.result=="Processing Completed"){e.onExecute()}}).catch(t=>{console.error("Error reading data:",t);e.oGlobalBusyDialog.close()})},loadXLSXLibrary:function(){return new Promise(function(e,t){if(window.XLSX){e();return}var a=document.createElement("script");a.src=jQuery.sap.getModulePath("pcf.com.acc.packaging.lib","/xlsx.full.min.js");a.onload=function(){e()};a.onerror=function(){t("Failed to load XLSX library")};document.head.appendChild(a)})},onMappedActivityChange:function(e){var t=e.getParameter("selectedItem");var a=t.getKey();let i=this.getView().getModel("excelData").getProperty("/results");const o=e.getSource().getBindingContext("excelData");let n=o.getProperty("top_activity_ids").filter(e=>e.result_id===a);o.setProperty("Total Emission",n[0].total_emission);if(n[0].activity_id=="custom"){o.setProperty(o.getPath()+"/btEditEnabled","Active")}else{o.setProperty(o.getPath()+"/btEditEnabled","InActive")}},onDownloadTemplate:function(){var e="PackagingTemplate.xlsx";var t=`./DownloadTemplate/${e}`;const a=document.createElement("a");a.href=t;a.style.display="none";document.body.appendChild(a);a.click();document.body.removeChild(a)},onExecute:function(){const e=this;var t=this.getOwnerComponent().getModel();i.readData(t,"/fetchAPI").then(t=>{var a=t.fetchAPI.result;a.forEach(e=>{const t=e.top_activity_ids.find(t=>t.result_id===e.active_result_id);e.mapped_activity_id=t?t.activity_id:null});var i=new sap.ui.model.json.JSONModel({results:a});this.getView().setModel(i,"excelData");this.getView().getModel().refresh(true);e.getOwnerComponent().getModel("locModel").setProperty("/btEditCEnabled",true);this.oGlobalBusyDialog.close()}).catch(e=>{console.error("Error reading data:",e);this.oGlobalBusyDialog.close()})},handleTxtFilter:function(e){const t=e.getParameter("query").trim();if(!t){this.byId("table").getBinding("rows").filter([]);return}const a=[new Filter("Site ID",FilterOperator.Contains,t),new Filter("Country Name",FilterOperator.Contains,t),new Filter("Material Name",FilterOperator.Contains,t),new Filter("Short Description",FilterOperator.Contains,t),new Filter("Spend Currency Unit",FilterOperator.Contains,t),new Filter("Weight Unit",FilterOperator.Contains,t)];const i=parseFloat(t);if(!isNaN(i)){a.push(new Filter("Material ID",FilterOperator.EQ,i),new Filter("Spend (in Millions)",FilterOperator.EQ,i),new Filter("Weight",FilterOperator.EQ,i))}const o=new Filter({filters:a,and:false});this.byId("table").getBinding("rows").filter(o)},onEditPress:function(e){var t=this;this.getView().byId("btSave").setVisible(true);this.getView().byId("btRun").setVisible(false);var a=e.getSource().getParent();var i=a.getCells();var o=i[9];var n=o.getItems()[0];if(n){n.setEditable(n.getEditable()===false)}},_getFileUploader:function(){return this.getView().byId("fileUploaderDialog")},_uploadFileExecute:function(){const e=this;t.show(0);return new Promise(async function(t,a){const i=e._getFileUploader();const o=i.oFileUpload.files[0];const n=o.name;sap.ui.getCore().fileUploadArr=[];const r=o.type;let s=await e._base64conversionMethod(r,n,o);if(s){let t={payload:[{data:s}]};e._sendPayload(t)}})},_base64conversionMethod:async function(e,t,a,i){return new Promise((o,n)=>{const r=this;if(!FileReader.prototype.readAsBinaryString){FileReader.prototype.readAsBinaryString=function(a){const o="";const n=new FileReader;n.onload=async function(a){const s=new Uint8Array(n.result);const l=s.byteLength;for(const e=0;e<l;e++){o+=String.fromCharCode(s[e])}r.base64ConversionRes=await btoa(o);sap.ui.getCore().fileUploadArr.push({DocumentType:i,MimeType:e,FileName:t,Content:r.base64ConversionRes})};n.readAsArrayBuffer(a)}}const s=new FileReader;s.onload=async function(a){const n=a.target.result;r.base64ConversionRes=await btoa(n);await sap.ui.getCore().fileUploadArr.push({DocumentType:i,MimeType:e,FileName:t,Content:r.base64ConversionRes});let s=(new sap.ui.getCore).fileUploadArr[0].Content;o(s)};s.readAsBinaryString(a)})},_chkFile:function(){const e=this.getView().getModel("i18n").getResourceBundle();const t=this._getFileUploader().oFileUpload.files[0];return new Promise(function(i,o){if(typeof t===UIConstants.undefined){a.error(e.getText("fileValidation"));return o()}else if(plantCd.length===0){a.error(e.getText("mandatoryChck"))}else{i()}})},_sendPayload:async function(e){const i=this;const o=i.getView().getModel("i18n").getResourceBundle();t.show(0);return await this.PackagingService.uploadData(e).then(function(e){t.hide();if(e.data){}else{a.error(o.getText("errorMsg"),{onClose:function(){}})}}.bind(this),function(e){t.hide();const i=JSON.parse(e.responseText).error.message.value;a.error(i,{onClose:function(){}})}.bind(this))},onImportExcel:function(){this.byId("fuV1000FileUploaderId").$().find("input")[0].click()},onFileSelected:function(e){var t=e.getParameter("files")[0];if(t){var i=new FileReader;i.onload=function(e){var t=e.target.result;var i=XLSX.read(t,{type:"binary"});var o=i.SheetNames[0];var n=i.Sheets[o];var r=XLSX.utils.sheet_to_json(n);if(!r||r.length===0){a.error("Please fill all the mandatory fields.");return}var s=["Site ID","Country Name","Material ID","Material Name","Short Description"];var l=r.every(e=>s.every(t=>e[t]&&e[t].toString().trim()!==""));if(!l){a.error("Please fill all the mandatory fields.");return}var c=new sap.ui.model.json.JSONModel;c.setData({results:r})}.bind(this);i.readAsBinaryString(t)}},onFileSelected:function(e){const t=e.getParameter("files")[0];if(t){this._selectedFile=t}},onUploadFile:function(){this.getView().getModel("excelData").setProperty("isDropdownEnabled",false);if(!this._selectedFile){sap.m.MessageToast.show("Please select a file first.");return}const e=["Site ID","Country Name","Material ID","Material Name","Short Description"];const t=this;this.loadXLSXLibrary().then(function(){var i=new FileReader;i.onload=function(i){var o=i.target.result;var n=XLSX.read(o,{type:"binary"});var r=n.SheetNames[0];var s=n.Sheets[r];var l=XLSX.utils.sheet_to_json(s,{defval:""});if(!l||l.length===0){a.error("Please fill all the mandatory fields.");t.getView().getModel("excelData").setData({results:[]});return}let c=[];l.forEach((t,a)=>{let i=e.every(e=>t[e]&&t[e].toString().trim()!=="");if(!i){c.push(a+2)}});if(c.length>0){a.error("Please fill all the mandatory fields.\nMissing fields Row Numbers: "+c.join(", "));t.getView().getModel("excelData").setData({results:[]});return}var d=new sap.ui.model.json.JSONModel;d.setData({results:l});t.getView().setModel(d,"excelData");a.success("File uploaded and validated successfully.");if(t._oUploadDialog){t._oUploadDialog.close()}};i.readAsBinaryString(t._selectedFile)}).catch(function(e){console.error(e)})},onOpenUploadDialog:function(){const e=this.getView().byId("fileUploaderDialog");if(e){e.clear();this._selectedFile=""}if(!this._oUploadDialog){this._oUploadDialog=new sap.m.Dialog({title:"Upload Excel File",contentWidth:"400px",content:[new sap.ui.unified.FileUploader({id:this.createId("fileUploaderDialog"),name:"upload",fileType:["xlsx","csv"],change:this.onFileSelected.bind(this)})],beginButton:new sap.m.Button({text:"Upload",press:this.onUploadFile.bind(this)}),endButton:new sap.m.Button({text:"Close",press:function(){this._oUploadDialog.close()}.bind(this)})})}this._oUploadDialog.open()},onExport:function(){const e=this.getView().getModel("excelData");if(!e||!e.getData().results||e.getData().results.length===0){sap.m.MessageBox.warning("No data available to export.");return}const t=e.getData().results;const a=XLSX.utils.json_to_sheet(t);const i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,a,"Exported Data");XLSX.writeFile(i,"PackagingEFData.xlsx")},onFilter:function(){var e=this._getSmartTable();if(e){e.openPersonalisationDialog("Filter")}},_getSmartTable:function(){if(!this._oSmartTable){this._oSmartTable=this.getView().byId("smartTable")}return this._oSmartTable}})});
//# sourceMappingURL=Packaging.controller.js.map